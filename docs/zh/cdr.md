# CDR 模块技术文档

🌐 **Languages**: [中文](cdr.md) | [English](../en/modules/cdr.md)

**级别**：AMS 子模块（RX）  
**类名**：`RxCdrTdf`  
**当前版本**：v0.2 (2026-01-20)  
**状态**：生产就绪

---

## 1. 概述

时钟数据恢复（CDR，Clock and Data Recovery）是SerDes接收端的核心模块，主要功能是从接收到的数据流中恢复时钟信息，并生成最佳采样相位，确保采样器在眼图最佳位置采样数据，从而最大化系统的误码容限。

### 1.1 设计原理

CDR的核心设计思想是利用数据跃变边沿携带的时钟信息，通过闭环反馈机制动态调整采样相位：

- **相位检测**：检测数据跃变边沿与当前采样时钟的相位关系，提取相位误差信息
- **环路滤波**：通过比例-积分（PI）控制器处理相位误差，抑制高频抖动，稳定环路
- **相位调整**：将滤波后的相位校正信号输出给采样器，实现动态相位跟踪

本模块采用经典的Bang-Bang相位检测器（BBPD）+ PI数字环路滤波器架构：

```
数据输入 → 边沿检测 → Bang-Bang相位检测器 → PI控制器 → 相位输出
           ↑                                              ↓
           └──────────────────相位反馈──────────────────────┘
```

相位检测器输出离散的早/晚（Early/Late）信号，经过PI控制器积分平均后转换为连续的相位调整量，输出给采样器的`phase_offset`端口。

### 1.2 核心特性

- **Bang-Bang相位检测**：基于数据跃变边沿的二值相位误差检测
- **数字PI环路滤波器**：可配置的比例增益（Kp）和积分增益（Ki）
- **相位范围限制**：可配置的相位调整范围和分辨率
- **与采样器协同**：输出相位调整信号（单位：秒），直接驱动采样器相位偏移
- **行为级模型**：适用于系统级仿真和算法验证

### 1.3 版本历史

| 版本 | 日期 | 主要变更 |
|------|------|----------|
| v0.1 | 2026-01-07 | 初始版本，Bang-Bang PD + PI控制器 |
| v0.2 | 2026-01-20 | 修复所有已知问题，代码与文档同步，达到生产就绪状态 |

---

## 2. 模块接口

### 2.1 端口定义（TDF域）

| 端口名 | 方向 | 类型 | 说明 |
|-------|------|------|------|
| `in` | 输入 | double | 接收数据输入（模拟信号，来自DFE或采样器） |
| `phase_out` | 输出 | double | 相位调整输出（单位：秒s） |

> **端口说明**：
> - `in`端口接收连续的模拟信号，CDR从数据跃变中提取时钟信息
> - `phase_out`端口输出相位偏移量（单位：秒），连接到采样器的`phase_offset`输入端口
> - 正值表示延迟采样（时钟晚），负值表示提前采样（时钟早）

### 2.2 参数配置

CDR模块的参数通过`CdrParams`结构体配置，包含两个子结构：PI控制器参数和相位插值器参数。

#### 2.2.1 PI控制器参数（CdrPiParams）

| 参数名 | 类型 | 默认值 | 说明 |
|-------|------|--------|------|
| `kp` | double | 0.01 | 比例增益（Proportional Gain） |
| `ki` | double | 1e-4 | 积分增益（Integral Gain） |

**工作原理**：

PI控制器是二阶数字环路滤波器，标准的离散时间公式为：
```
积分状态: I[n] = I[n-1] + Ki × e[n]
PI输出:    φ[n] = Kp × e[n] + I[n]
```
其中：
- `φ[n]`：第n个采样时刻的输出相位
- `e[n]`：相位误差（Bang-Bang PD输出±1）
- `I[n]`：积分状态（历史误差累积）
- `Kp`：比例增益，控制瞬态响应速度
- `Ki`：积分增益，消除稳态相位误差

**参数调节指南**：

- **Kp（比例增益）**：
  - 增大Kp加快相位锁定速度，但过大会导致振荡
  - 典型范围：0.001 ~ 0.1
  - 默认值0.01适用于10Gbps系统

- **Ki（积分增益）**：
  - 增大Ki提升跟踪精度，但过大会降低环路稳定性
  - 典型关系：Ki ≈ Kp/10 ~ Kp/100
  - 默认值1e-4与Kp=0.01匹配

**环路特性**：

二阶PI环路的自然频率ωn和阻尼系数ζ由Kp和Ki决定（基于线性化分析）：
```
ωn = √(Ki × Fs)
ζ = Kp / (2 × ωn)
```
其中Fs为采样率。推荐ζ在0.7~1.0之间以获得最佳阶跃响应。

> ⚠️ **重要提示**：上述公式基于**线性相位检测器**的假设，通过连续时间域的线性化推导得出。但本模块采用的是**Bang-Bang相位检测器**（输出离散的±1），其非线性特性导致实际环路行为与线性理论有偏差：
> - Bang-Bang PD缺乏线性区间，无法提供连续的相位误差信息
> - 实际的环路带宽和阻尼系数会偏离理论计算值
> - 离散二值输出会引入额外的相位抖动（参见7.2节）
> 
> 因此，这些公式仅作为**初步设计的近似估算**，实际参数需通过仿真验证和调优。

#### 2.2.2 相位插值器参数（CdrPaiParams）

| 参数名 | 类型 | 默认值 | 说明 |
|-------|------|--------|------|
| `resolution` | double | 1e-12 | 相位调整分辨率（单位：秒s） |
| `range` | double | 5e-11 | 相位调整范围（单位：秒s） |

**工作原理**：

相位插值器（Phase Interpolator）将数字环路滤波器输出的相位控制字转换为实际的时间偏移。

- **分辨率（resolution）**：
  - 定义相位调整的最小步进
  - 默认1ps（1e-12秒）对应高精度硬件实现
  - 物理意义：硬件相位插值器的DNL（微分非线性度）
  - 更粗的分辨率（如5ps）可模拟低成本实现

- **范围（range）**：
  - 定义相位调整的最大偏移量（±range）
  - 默认50ps（±25ps）足以覆盖典型频偏和抖动
  - 物理意义：相位插值器的线性范围
  - 应大于预期的最大频率偏移 × UI

**实际应用示例**：

对于10Gbps系统（UI = 100ps）：
- 频偏±500ppm → 最大相位偏移 = ±50ps → range设置≥50ps
- 硬件相位插值器6-bit → 分辨率 = UI/64 ≈ 1.5ps

#### 2.2.3 完整参数结构

```cpp
struct CdrParams {
    CdrPiParams pi;      // PI控制器参数
    CdrPaiParams pai;    // 相位插值器参数
};
```

**JSON配置示例**：

```json
{
  "cdr": {
    "pi": {
      "kp": 0.01,
      "ki": 1e-4
    },
    "pai": {
      "resolution": 1e-12,
      "range": 5e-11
    }
  }
}
```

### 2.3 端口连接示例

CDR模块通常连接在采样器或DFE之后，输出相位信号反馈给采样器：

```cpp
// 实例化CDR模块
CdrParams cdr_params;
cdr_params.pi.kp = 0.01;
cdr_params.pi.ki = 1e-4;
RxCdrTdf cdr("cdr", cdr_params);

// 连接信号
cdr.in(data_signal);              // 来自DFE或采样器
cdr.phase_out(phase_adjust_sig);  // 输出到采样器的phase_offset端口

// 采样器连接（闭环）
sampler.phase_offset(phase_adjust_sig);  // 接收CDR相位调整
sampler.data_out(sampled_data);
cdr.in(sampled_data);  // 或连接到均衡后的模拟信号
```

---

## 3. 核心实现机制

### 3.1 信号处理流程

CDR模块的`processing()`方法实现以下处理步骤：

```
步骤1: 读取输入数据 → 步骤2: 边沿检测 → 步骤3: Bang-Bang相位检测 → 
步骤4: PI控制器更新 → 步骤5: 相位范围限制 → 步骤6: 输出相位调整
```

**步骤1 - 读取输入数据**：从`in`端口读取当前采样点的数据信号。

**步骤2 - 边沿检测**：通过比较当前比特与前一比特，检测数据跃变：
```cpp
double current_bit = in.read();
if (std::abs(current_bit - m_prev_bit) > threshold) {
    // 检测到边沿
}
```

**步骤3 - Bang-Bang相位检测**：在检测到边沿时，判断相位早晚：
- 如果 `current_bit > m_prev_bit`（上升沿）→ 相位误差 = +1（时钟晚）
- 如果 `current_bit < m_prev_bit`（下降沿）→ 相位误差 = -1（时钟早）
- 无边沿时相位误差 = 0

> ⚠️ **简化实现的错误**：
> - 上述逻辑是**错误的简化**，不符合真实的Bang-Bang相位检测器工作原理
> - 真实的BBPD需要使用**数据采样器和边沿采样器的异或结果**来判断相位早晚，而不是简单地根据边沿极性判断
> - 当前实现仅用于演示CDR环路结构，实际应用需使用完整的BBPD架构（见3.2节）

**步骤4 - PI控制器更新**：根据相位误差更新相位累积量：
```cpp
m_integral += ki * phase_error;  // 积分状态更新
double phase_output = kp * phase_error + m_integral;  // PI输出
```

**步骤5 - 相位范围限制**：将相位输出限制在±range范围内：
```cpp
if (phase_output > range) phase_output = range;
if (phase_output < -range) phase_output = -range;
```

**步骤6 - 相位量化**：将相位输出量化到配置的分辨率：
```cpp
double quantized_phase = std::round(phase_output / resolution) * resolution;
```

**步骤7 - 输出相位调整**：将相位调整量写入`phase_out`端口，传递给采样器。

### 3.2 Bang-Bang相位检测器原理

Bang-Bang相位检测器（BBPD）是一种二值（Binary）相位检测器，通过数据跃变边沿判断采样相位的早晚：

**理想工作原理**：

在数据跃变边沿处，采样得到的数据值反映了采样时刻相对于数据中心的相位关系：
- 如果采样时刻早于数据中心，边沿采样会更接近旧数据
- 如果采样时刻晚于数据中心，边沿采样会更接近新数据

**当前实现**：

当前版本采用边沿极性检测：
```
上升沿（0→1）：认为时钟晚（需要提前） → phase_error = +1
下降沿（1→0）：认为时钟早（需要延后） → phase_error = -1
```

> **注意**：这是边沿极性检测的简化实现。完整的BBPD需要使用数据采样器（Data Sampler）和边沿采样器（Edge Sampler）进行异或比较。

**完整BBPD架构**（未来版本）：

```
         ┌──────────────┐
data ───→│ Data Sampler │──→ D[n]
  │      └──────────────┘       │
  │                             ↓
  │      ┌──────────────┐    ┌─────┐
  └─────→│ Edge Sampler │──→ │ XOR │──→ phase_error
         └──────────────┘    └─────┘
              (早采样)            ↑
                                  D[n-1]
```

相位误差 = D[n-1] ⊕ Edge[n]：
- 0 ⊕ 0 = 0（无误差或大误差）
- 0 ⊕ 1 = 1（时钟晚）
- 1 ⊕ 0 = 1（时钟早）
- 1 ⊕ 1 = 0（无误差或大误差）

### 3.3 PI控制器设计

PI（比例-积分）控制器是经典的二阶数字环路滤波器，兼顾快速响应和稳态精度。

**离散时间传递函数**：

```
H(z) = Kp + Ki/(1 - z⁻¹)
```

**时域递推公式**：

```cpp
// 积分状态更新
I[n] = I[n-1] + Ki × e[n]

// PI输出
φ[n] = Kp × e[n] + I[n]
```

其中：
- `φ[n]`：第n个采样时刻的输出相位
- `e[n]`：相位误差（Bang-Bang PD输出±1）
- `I[n]`：积分状态（历史误差累积）
- `Kp`：比例增益，控制瞬态响应速度
- `Ki`：积分增益，消除稳态相位误差

**C++实现**：

```cpp
// 积分项：累积历史误差
m_integral += ki * phase_error;

// 比例项：瞬时响应
double prop_term = kp * phase_error;

// 总输出
double phase_out = prop_term + m_integral;
```

**环路特性分析**：

对于二阶PI环路，开环传递函数为：
```
G(s) = (Kp × s + Ki) / s²
```

闭环特征方程决定环路稳定性和阶跃响应：
- **自然频率**：ωn = √(Ki × Fs)，决定响应速度
- **阻尼系数**：ζ = Kp / (2 × ωn)，决定过冲和振荡
- **环路带宽**：BW ≈ ωn，决定抖动跟踪能力

推荐设计准则：
- ζ ≈ 0.707（临界阻尼）获得最快无过冲响应
- BW ≈ 数据速率/1000 ~ 数据速率/10000（如10Gbps → 1~10MHz）

**PI控制器的Z域分析**：

在离散时间系统中，PI控制器的Z域传递函数为：
```
H(z) = Kp + Ki × T / (1 - z⁻¹)
```
其中T为采样周期（对于baud-rate CDR，T = UI）。将其转换为差分方程：
```
y[n] = y[n-1] + Kp × (e[n] - e[n-1]) + Ki × T × e[n]
```
这里可以看出：
- **比例项**：Kp × (e[n] - e[n-1])，仅响应误差的变化量
- **积分项**：Ki × T × e[n]，累积所有历史误差

**相位更新速率与数据速率的关系**：

本CDR设计采用baud-rate架构，即每个数据比特触发一次相位检测和更新：
- 数据速率 = 10 Gbps → 相位更新速率 = 10 GHz
- UI = 100 ps → 相位更新周期 = 100 ps
- 环路延迟 = 1 UI（相位误差检测 → PI计算 → 相位应用）

更高的更新速率带来更快的锁定速度和更好的抖动跟踪能力，但也增加了功耗和设计复杂度。某些CDR使用1/2或1/4 baud-rate以降低功耗，但会牺牲跟踪带宽。

**边沿检测阈值选择**：

当前实现使用固定阈值0.5来检测数据跃变，这在以下情况下会失效：
- 信号摆幅不为单位归一化（如CTLE输出为±0.3V）
- 存在直流偏移（如VGA输出共模电压漂移）
- 信号衰减严重（信道损耗导致边沿幅度不足）

**改进方案**：
```cpp
// 自适应阈值检测
double threshold = 0.5 * (max_signal - min_signal);  // 相对于信号摆幅
double edge_detect = std::abs(current_bit - m_prev_bit) > threshold;
```
或者使用峰值检测器动态跟踪信号摆幅，将阈值设置为摆幅的10%~20%。

---

## 4. 测试平台架构

### 4.1 测试平台设计思想

CDR测试平台采用闭环集成设计，需要与采样器模块紧密协同才能验证相位跟踪能力。核心设计理念：

1. **闭环架构**：CDR和Sampler构成相位反馈闭环，相位调整结果直接影响采样质量
2. **场景驱动**：覆盖频率捕获、相位跟踪、抖动容限、锁定检测等关键测试场景
3. **性能评估**：支持BER测试、锁定时间测量、相位误差统计等性能指标
4. **可配置性**：支持多种参数配置和场景切换，便于性能对比和优化

**与其他模块测试平台的区别**：

- CTLE/VGA等模块可独立测试（开环）
- CDR必须与Sampler组成闭环才能验证功能
- 需要精确控制输入数据的频率偏移和抖动
- 测试指标包括动态特性（锁定时间、跟踪带宽）

### 4.2 测试场景定义

测试平台支持五种核心测试场景，覆盖CDR的主要功能和性能指标：

| 场景 | 命令行参数 | 测试目标 | 输出文件 |
|------|----------|---------|----------|
| PHASE_LOCK_BASIC | `lock` / `0` | 基本相位锁定功能验证 | cdr_tran_lock.csv |
| FREQUENCY_OFFSET | `freq` / `1` | 频率偏移捕获能力 | cdr_tran_freq.csv |
| JITTER_TOLERANCE | `jtol` / `2` | 抖动容限测试（JTOL） | cdr_tran_jtol.csv |
| PHASE_TRACKING | `track` / `3` | 动态相位跟踪能力 | cdr_tran_track.csv |
| LOOP_BANDWIDTH | `bw` / `4` | 环路带宽测量 | cdr_tran_bw.csv |

### 4.3 场景配置详解

#### PHASE_LOCK_BASIC - 基本相位锁定测试

验证CDR从初始随机相位锁定到最佳采样相位的基本功能。

- **信号源**：PRBS-15伪随机序列
- **数据速率**：10 Gbps（UI = 100ps）
- **初始相位偏移**：随机（0~UI范围内）
- **PI参数**：Kp=0.01, Ki=1e-4（默认值）
- **仿真时间**：≥10,000 UI（确保环路收敛）
- **验证点**：
  - 相位误差收敛到±5ps以内
  - BER < 1e-12
  - 锁定后相位稳定（无持续振荡）

**期望波形特征**：
- 相位调整信号从初始值单调收敛到稳态值
- 收敛过程呈指数衰减（二阶系统特性）
- 锁定后存在小幅抖动（Bang-Bang PD固有特性）

**调试要点**（针对已知bug）：
- 检查相位检测器输出是否正确反映早/晚信息
- 验证PI控制器的比例项和积分项是否正确分离
- 确认相位输出信号正确连接到采样器

#### FREQUENCY_OFFSET - 频率偏移捕获测试

验证CDR捕获和补偿发送端与接收端频率偏移的能力。

- **信号源**：10 Gbps PRBS-7
- **频率偏移**：±100ppm, ±500ppm, ±1000ppm（分级测试）
- **PI参数**：Kp=0.01, Ki=1e-4
- **PI range**：必须≥ |freq_offset| × UI × 锁定时间
- **仿真时间**：≥50,000 UI
- **验证点**：
  - 系统能否在规定时间内锁定
  - 锁定后相位漂移速率 = 频偏对应的相位斜率
  - 相位调整范围未超出pai.range限制

**物理意义**：

频率偏移导致相位以固定速率累积：
```
相位漂移率 = freq_offset × UI
例如：100ppm @ 10Gbps → 100ps/1e6 UI = 0.1fs/UI
```

CDR的积分项Ki负责跟踪这一恒定相位斜率，如果Ki过小则无法完全消除静态相位误差。

**测试步骤**：
1. 配置发送端频率偏移（通过时钟周期微调）
2. CDR从初始状态启动
3. 记录相位调整信号的时域波形
4. 测量锁定时间（相位误差稳定到±10ps）
5. 验证锁定后的相位斜率是否匹配频偏

#### JITTER_TOLERANCE - 抖动容限测试

验证CDR对输入数据抖动的容忍能力，是SerDes系统的关键性能指标。

- **信号源**：10 Gbps PRBS-31（长序列保证统计有效性）
- **抖动类型**：
  - **随机抖动（RJ）**：高斯分布，σ = 1ps, 2ps, 5ps
  - **周期性抖动（SJ）**：正弦调制，频率扫描（1kHz ~ 100MHz）
  - **组合抖动**：RJ + SJ叠加
- **测试方法**：固定抖动幅度，扫描抖动频率，记录BER
- **PI参数**：Kp=0.01, Ki=1e-4
- **仿真时间**：每个频率点≥1e6 UI（保证BER测量精度）
- **验证点**：
  - 绘制JTOL曲线（抖动容限 vs 频率）
  - 验证低频抖动跟踪能力（频率 < 环路带宽）
  - 验证高频抖动抑制能力（频率 > 环路带宽）

**JTOL曲线特征**：

```
抖动容限（UI）
    ^
1.0 |━━━━━┓                     ← 低频：完美跟踪
    |      ┗━━━━┓                ← 转折频率 ≈ 环路带宽
0.5 |           ┗━━━━┓           ← 斜率 -20dB/decade
    |                ┗━━━━━━━    ← 高频：固有容限
0.1 |________________________
        1k  10k 100k  1M  10M  100M  (Hz)
```

**关键频率点**：
- **低频段（< BW/10）**：CDR完全跟踪抖动，容限 ≈ 1 UI
- **转折频率（≈ BW）**：容限开始下降
- **高频段（> 10×BW）**：CDR无法跟踪，容限由采样器固有裕量决定

#### PHASE_TRACKING - 动态相位跟踪测试

验证CDR对动态相位调制的跟踪能力。

- **信号源**：10 Gbps PRBS-7
- **相位调制**：正弦波调制采样相位
  - 调制频率：100kHz, 1MHz, 10MHz
  - 调制幅度：±10ps, ±20ps, ±50ps
- **PI参数**：Kp=0.01, Ki=1e-4
- **仿真时间**：≥100个调制周期
- **验证点**：
  - 计算跟踪误差（输入相位调制 vs CDR输出相位）
  - 测量跟踪延迟（相位差）
  - 验证环路带宽（-3dB点）

**相位跟踪传递函数**：

CDR环路的闭环传递函数（相位输出/相位输入）具有低通特性：
```
H(f) = (Kp×s + Ki) / (s² + Kp×s + Ki)  （连续域近似）

-3dB带宽 ≈ √Ki  （rad/s）
```

通过扫描调制频率，测量输出/输入幅度比，可绘制传递函数曲线验证理论带宽。

#### LOOP_BANDWIDTH - 环路带宽测量

精确测量CDR环路的实际带宽，验证与理论设计的符合度。

- **测试原理**：向数据流注入已知幅度的相位调制，测量CDR输出的幅度响应
- **调制频率扫描**：10kHz ~ 100MHz（对数间隔，每倍频10个点）
- **调制幅度**：固定20ps（小信号线性范围）
- **PI参数**：多组参数对比（验证Kp/Ki对带宽的影响）
- **输出**：Bode图（幅频响应和相频响应）
- **验证点**：
  - -3dB带宽与理论计算对比（误差应<20%）
  - 相位裕度 > 45°（稳定性指标）
  - 无谐振峰值（阻尼充分）

**测试配置表**：

| Kp | Ki | 理论BW (MHz) | 理论ζ |
|----|-------|-------------|-------|
| 0.005 | 2.5e-5 | 2.5 | 0.707 |
| 0.01 | 1e-4 | 5.0 | 0.707 |
| 0.02 | 4e-4 | 10.0 | 0.707 |

通过对比不同参数组的实际带宽，验证参数调节的有效性。

### 4.4 信号连接拓扑

CDR测试平台的核心是CDR与Sampler的闭环连接：

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│ DiffSignalSource│       │  RxSamplerTdf   │       │   RxCdrTdf      │
│  (PRBS + Jitter)│       │                 │       │                 │
│                 │       │                 │       │                 │
│  out_p ─────────┼───────▶ inp             │       │                 │
│  out_n ─────────┼───────▶ inn             │       │                 │
└─────────────────┘       │                 │       │                 │
                          │  data_out ──────┼───────▶ in              │
                          │                 │       │                 │
                          │  phase_offset ◀─┼───────┤ phase_out       │
                          └─────────────────┘       └─────────────────┘
                                   │                          │
                                   ▼                          ▼
                          ┌─────────────────┐       ┌─────────────────┐
                          │  SamplerMonitor │       │   CdrMonitor    │
                          │  - BER统计      │       │  - 相位波形     │
                          │  - 眼图采集     │       │  - 锁定检测     │
                          └─────────────────┘       └─────────────────┘
```

**关键连接说明**：

1. **差分信号源 → 采样器**：
   - 提供带抖动/频偏的差分数据信号
   - 支持可编程抖动注入（RJ/SJ）
   - 支持可编程频率偏移

2. **采样器 → CDR（前向路径）**：
   - 连接方式取决于CDR输入类型：
     - **方案A**：Sampler.data_out → CDR.in（数字信号）
     - **方案B**：均衡器输出 → CDR.in（模拟信号，需要边沿采样器）
   - 当前简化实现使用方案A

3. **CDR → 采样器（反馈路径）**：
   - CDR.phase_out → Sampler.phase_offset
   - 相位调整单位：秒（s）
   - 正值=延迟采样，负值=提前采样

4. **监控器连接**：
   - SamplerMonitor：统计BER、采集眼图数据
   - CdrMonitor：记录相位调整波形、检测锁定状态

**环路延迟考虑**：

CDR环路存在固有延迟（信号传播+处理延迟），影响环路稳定性：
```
总延迟 = Sampler延迟 + CDR处理延迟 + 相位应用延迟
典型值：1~2 UI
```

测试平台应支持延迟可配置，验证延迟对锁定性能的影响。

### 4.5 辅助模块说明

#### DiffSignalSource - 差分信号源（增强版）

为CDR测试定制的信号源，支持精确的频率和抖动控制：

**波形类型**：
- PRBS-7/15/31：不同长度序列，验证CDR对数据模式的适应性
- Alternating Pattern（010101...）：最大跃变密度，验证相位检测器响应
- Low Transition Density（稀疏跃变）：验证CDR在低跃变率下的保持能力

**抖动注入能力**：

| 抖动类型 | 参数 | 说明 |
|---------|------|------|
| 随机抖动（RJ） | sigma（标准差） | 高斯分布，典型值0.5~5ps |
| 周期性抖动（SJ） | 频率、幅度 | 正弦调制，支持多音叠加 |
| 有界非相关抖动（BUJ） | 峰峰值 | 均匀分布 |
| 占空比失真（DCD） | 偏移量 | 高低电平时间不对称 |

**频率偏移控制**：

通过调整符号周期实现精确频偏：
```cpp
实际UI = 标称UI × (1 + freq_offset_ppm / 1e6)
例如：10Gbps + 100ppm → UI = 100ps × 1.0001 = 100.01ps
```

**配置示例**：
```json
{
  "signal_source": {
    "data_rate": 10e9,
    "pattern": "PRBS31",
    "jitter": {
      "rj_sigma": 2e-12,
      "sj_freq": 1e6,
      "sj_amplitude": 10e-12
    },
    "freq_offset_ppm": 100
  }
}
```

#### SamplerMonitor - 采样器监控模块

监控采样器输出，评估CDR性能对BER的影响：

**功能**：
- **BER实时统计**：比对采样输出与理想参考序列
- **误码位置记录**：时间戳、误码类型（单比特/突发）
- **眼图采集**：记录采样点的幅度和相位分布
- **统计分析**：Q-factor、眼高、眼宽

**输出文件**：
- `sampler_monitor.csv`：逐比特记录（时间、数据、参考、误码标志）
- `ber_summary.json`：BER统计结果和眼图参数

#### CdrMonitor - CDR状态监控模块

专用于CDR内部状态监控和性能分析：

**监控信号**：
| 信号 | 说明 |
|------|------|
| phase_out | 相位调整输出波形 |
| phase_error | 相位检测器输出（内部信号，需调试接口） |
| lock_status | 锁定状态指示（需实现锁定检测器） |
| integral_state | PI控制器积分状态（内部信号） |

**分析功能**：
- **锁定时间测量**：从启动到相位误差<阈值的时间
- **锁定抖动统计**：稳态时相位调整信号的RMS抖动
- **环路响应分析**：阶跃响应、频率响应测量
- **参数优化建议**：基于实测性能推荐Kp/Ki调整

**输出**：
- `cdr_phase.csv`：相位波形数据
- `cdr_performance.json`：性能指标汇总
- `cdr_debug.log`：内部状态日志（debug模式）

**Debug模式特性**：

测试平台支持debug模式输出中间状态，用于性能分析和参数调优：
```json
{
  "debug_mode": true,
  "debug_signals": [
    "phase_detector_output",
    "proportional_term",
    "integral_term",
    "phase_before_limit",
    "phase_after_limit"
  ]
}
```

这些内部信号的波形对于诊断相位检测器行为和PI控制器性能至关重要。

#### JitterInjector - 抖动注入模块（可选）

独立的抖动注入模块，可插入信号链任意位置：

**应用场景**：
- 在Sampler输入端注入：模拟信道抖动
- 在CDR输入端注入：模拟采样器抖动
- 在时钟路径注入：模拟参考时钟抖动

**注入方式**：
- **时间域调制**：直接调制信号时间轴
- **相位域调制**：调制采样相位（与CDR输出相加）

**配置示例**：
```json
{
  "jitter_injector": {
    "enable": true,
    "type": "sinusoidal",
    "frequency": 1e6,
    "amplitude": 20e-12,
    "insertion_point": "sampler_input"
  }
}
```

---

## 5. 仿真结果分析

本章介绍CDR测试平台各场景的典型仿真结果解读方法、关键性能指标定义及分析手段。

### 5.1 统计指标说明

CDR性能评估涉及多种时域和频域指标，以下给出关键指标的定义和计算方法。

#### 5.1.1 时域指标

**相位误差（Phase Error）**

定义为采样相位与最佳采样相位的偏差，单位为秒（s）或UI：

```
相位误差 = CDR输出相位 - 最佳采样相位
```

**统计量**：
- **均值（Mean）**：稳态相位偏移，理想应为0
- **标准差（Std Dev）**：相位抖动RMS，反映CDR环路噪声
- **峰峰值（Peak-to-Peak）**：最大相位偏差，影响时序裕量

**单位转换**：
```
相位误差(UI) = 相位误差(s) / UI周期(s)
例如：10Gbps系统，5ps误差 = 5ps / 100ps = 0.05 UI
```

**锁定时间（Lock Time）**

从CDR启动到相位误差收敛到指定阈值所需的时间。常用阈值：
- 粗锁定：相位误差 < 0.1 UI
- 精锁定：相位误差 < 0.05 UI（5ps @ 10Gbps）

计算方法（伪代码）：
```python
def calculate_lock_time(phase_error_vec, time_vec, threshold=0.05):
    """
    计算锁定时间
    
    参数：
    phase_error_vec: 相位误差时间序列（单位：UI）
    time_vec: 对应的时间戳（单位：秒）
    threshold: 锁定阈值（单位：UI）
    
    返回：
    lock_time: 锁定时间（单位：秒）
    """
    # 计算移动窗口内的最大误差
    window_size = 100  # 窗口长度：100个符号
    for i in range(len(phase_error_vec) - window_size):
        window = phase_error_vec[i:i+window_size]
        if np.max(np.abs(window)) < threshold:
            return time_vec[i]
    return None  # 未锁定
```

**锁定抖动（Lock Jitter）**

锁定后相位误差的RMS值，反映CDR稳态性能：

```
锁定抖动 = std(相位误差[锁定后])
```

典型值：
- Bang-Bang PD：1~5ps RMS（取决于环路带宽）
- 线性PD（Hogge/Alexander）：0.5~2ps RMS

#### 5.1.2 频域指标

**环路带宽（Loop Bandwidth）**

环路闭环传递函数的-3dB截止频率，决定CDR的跟踪能力：

```
H(f) = (Kp×s + Ki) / (s² + Kp×s + Ki)  （s域）
-3dB带宽 ≈ √(Ki) / (2π)  （Hz）
```

**测量方法**：
1. 向输入注入扫频相位调制
2. 测量输出/输入的幅度比
3. 找到幅度比下降至-3dB的频率点

**相位裕度（Phase Margin）**

环路开环传递函数在增益为0dB时的相位与-180°的差值，衡量稳定性裕量：

```
PM = 180° + ∠H(f_crossover)
```

典型要求：PM > 45°（保证稳定且响应不振荡）

**抖动容限（Jitter Tolerance）**

CDR能够容忍的最大输入抖动幅度（通常以UI为单位），与频率相关。在特定BER目标（如1e-12）下测量：

```
JTOL(f) = 能容忍的抖动幅度(UI) @ 抖动频率f
```

典型JTOL曲线特征（参见4.3.3节）：
- 低频（f < BW/10）：容限 ≈ 1 UI（完美跟踪）
- 中频（f ≈ BW）：转折区，斜率-20dB/decade
- 高频（f > 10×BW）：容限由采样器固有裕量决定

#### 5.1.3 系统级指标

**误码率（BER）**

采样器输出与理想参考的误码比例：

```
BER = 误码比特数 / 总比特数
```

**BER与相位误差的关系**：

假设信号幅度为A，噪声标准差为σ，相位误差导致采样点偏离最佳位置：

```
Q = (A - Δ) / σ
BER ≈ 0.5 × erfc(Q / √2)

其中：Δ = 相位误差对应的电压偏移
```

对于阶跃信号，相位误差导致的幅度损失：
```
Δ ≈ 信号斜率 × 相位误差 = (A / 转换时间) × 相位误差
```

**Q-factor**

信噪比的另一种表示，与BER的关系：

```
Q = √2 × erfc⁻¹(2 × BER)
Q(dB) = 20 × log₁₀(Q)
```

典型对应关系：
- BER = 1e-12 → Q ≈ 7.0 → Q(dB) ≈ 16.9dB
- BER = 1e-15 → Q ≈ 7.9 → Q(dB) ≈ 18.0dB

### 5.2 典型测试结果解读

以下针对第4章定义的五个测试场景，给出结果解读方法和理想预期。

#### 5.2.1 PHASE_LOCK_BASIC - 基本相位锁定测试

**测试配置**：
- 数据速率：10 Gbps（UI = 100ps）
- 初始相位偏移：随机（0~100ps）
- PI参数：Kp=0.01, Ki=1e-4
- 仿真时间：10,000 UI（1μs）

**理想结果预期**：

1. **相位收敛曲线**：
   - 初始阶段：相位误差从初始值单调下降
   - 收敛时间：约2000~3000 UI（环路时间常数 τ ≈ 1/√Ki）
   - 稳态误差：均值 < 1ps，RMS < 3ps

2. **BER性能**：
   - 锁定前：可能出现误码（相位未对准）
   - 锁定后：BER < 1e-12（无误码或极低误码）

3. **PI控制器状态**：
   - 比例项（Kp × phase_error）：快速响应，振荡逐渐衰减
   - 积分项（∑Ki × phase_error）：单调增加至稳态值

**波形特征示例**：

```
相位误差(ps)
  100 |●                           ← 初始随机偏移
      |  ●●
   50 |     ●●●
      |        ●●●
    0 |___________●●●●━━━━━━━━━   ← 锁定至稳态（小幅抖动）
      |
  -50 |
      └────────────────────────────▶ 时间(UI)
        0    1k   2k   3k   4k   10k
```

**验证方法**：
```bash
./cdr_tran_tb lock
python scripts/plot_cdr_phase.py cdr_tran_lock.csv
```

检查项：
- [ ] 相位误差是否单调收敛
- [ ] 锁定时间是否合理（< 5000 UI）
- [ ] 稳态抖动是否在预期范围（< 5ps RMS）

#### 5.2.2 FREQUENCY_OFFSET - 频率偏移捕获测试

**测试配置**：
- 频率偏移：±100ppm, ±500ppm, ±1000ppm
- PI参数：Kp=0.01, Ki=1e-4
- 仿真时间：50,000 UI（5μs）

**理想结果预期**：

1. **相位漂移特征**：
   - 频偏导致相位以固定速率累积
   - 100ppm @ 10Gbps → 相位斜率 ≈ 0.01ps/UI = 10ps/1000UI
   - CDR的积分项Ki跟踪这一斜率

2. **锁定条件**：
   - 稳态相位误差 = 频偏斜率 / Ki
   - 相位调整范围不能超出PAI.range限制
   - 例如：100ppm偏移，50,000 UI后累积相位偏移 = 100ps × 0.0001 × 50,000 = 500ps

3. **极限测试**：
   - 当频偏过大或Ki过小时，积分器无法跟上，相位持续漂移
   - 此时需要增大Ki或实现频率检测器（FD）辅助捕获

**波形特征示例**：

```
相位输出(ps)
  500 |                     ●●●●●●   ← 积分器累积至稳态斜率
      |                 ●●●●
  250 |             ●●●●
      |         ●●●●
    0 |●●●●●●●●
      └────────────────────────────▶ 时间(UI)
        0    10k   20k   30k   40k  50k

相位斜率 = Δphase / ΔUI ≈ 频偏对应值
```

**BER影响**：
- 如果CDR成功跟踪频偏：BER正常（< 1e-12）
- 如果相位超出PAI.range：BER突变（周期性相位绕卷）

**验证方法**：
```bash
for ppm in 100 500 1000; do
  ./cdr_tran_tb freq --freq_offset_ppm=$ppm
done
python scripts/analyze_freq_offset.py
```

检查项：
- [ ] 相位斜率是否匹配频偏（误差 < 10%）
- [ ] 相位调整范围是否在限制内
- [ ] BER是否保持正常

#### 5.2.3 JITTER_TOLERANCE - 抖动容限测试

**测试配置**：
- 抖动类型：正弦调制（SJ）
- 抖动频率扫描：1kHz ~ 100MHz（对数间隔）
- 抖动幅度：固定或自适应（目标BER = 1e-12）
- 每频率点测试时长：≥ 1e6 UI

**理想结果预期**：

JTOL曲线呈典型的低通特性（参见4.3.3节图示）：

| 频率范围 | 容限特性 | 物理原因 |
|---------|---------|---------|
| < BW/10 | 1.0 UI | CDR完全跟踪抖动 |
| BW/10 ~ BW | 下降转折 | 环路增益开始衰减 |
| BW ~ 10×BW | -20dB/decade斜率 | 一阶低通滚降 |
| > 10×BW | 0.3~0.5 UI | 采样器固有容限 |

**具体数值示例**（假设BW = 5MHz）：

| 抖动频率 | 理论容限(UI) | 说明 |
|---------|------------|------|
| 1 kHz | 1.0 | 低频完全跟踪 |
| 100 kHz | 1.0 | 仍在跟踪区 |
| 1 MHz | 0.95 | 接近转折 |
| 5 MHz | 0.707 | -3dB点 |
| 10 MHz | 0.5 | 高频滚降 |
| 50 MHz | 0.2 | 超出带宽，容限小 |
| 100 MHz | 0.3 | 固有容限（不再下降） |

**测量方法**：

对于每个频率点：
1. 从小幅度开始增加抖动
2. 运行长时间仿真（≥1e6 UI）
3. 测量BER
4. 找到BER刚好超过阈值（如1e-12）的抖动幅度
5. 该幅度即为该频率的抖动容限

**输出文件格式**：

```csv
抖动频率(Hz), 抖动幅度(ps), 抖动幅度(UI), BER
1000, 100.0, 1.00, 1e-15
10000, 98.5, 0.985, 5e-13
100000, 95.2, 0.952, 1e-12
1000000, 80.3, 0.803, 1e-12
5000000, 70.7, 0.707, 1e-12
10000000, 50.1, 0.501, 1e-12
50000000, 30.5, 0.305, 1e-12
100000000, 30.2, 0.302, 1e-12
```

**绘图命令**：
```bash
python scripts/plot_jtol_curve.py cdr_tran_jtol.csv
```

生成Bode图风格的JTOL曲线（x轴对数刻度，y轴UI或dB）。

**验证标准**：
- [ ] 低频容限 ≥ 0.9 UI
- [ ] -3dB转折频率 ≈ 理论环路带宽（误差 < 30%）
- [ ] 高频斜率 ≈ -20dB/decade
- [ ] 无异常谐振峰值

#### 5.2.4 PHASE_TRACKING - 动态相位跟踪测试

**测试配置**：
- 相位调制：正弦波，频率扫描（100kHz ~ 10MHz）
- 调制幅度：固定20ps（小信号）
- PI参数：Kp=0.01, Ki=1e-4（理论BW ≈ 5MHz）
- 仿真时间：≥100个调制周期

**理想结果预期**：

1. **低频跟踪（f < BW）**：
   - CDR输出与输入同步
   - 幅度衰减 < 3dB
   - 相位延迟 < 90°

2. **高频衰减（f > BW）**：
   - 输出幅度按-20dB/decade滚降
   - 相位延迟接近-180°

3. **传递函数验证**：

绘制Bode图（幅频响应和相频响应）：

```
幅度(dB)
   0 |━━━━━━┓                      ← 通带（低频）
     |       ┗━━┓                   ← -3dB点 ≈ 5MHz
  -3 |           ┗━━┓               
     |              ┗━━━┓           
 -20 |                  ┗━━━━┓     ← -20dB/decade斜率
     └─────────────────────────▶ 频率(Hz)
       100k  1M    10M   100M

相位(deg)
   0 |━━━━━┓
     |      ┗━━━┓                   ← 相位开始滞后
 -90 |          ┗━━━┓               ← -90°点 ≈ BW
     |              ┗━━━┓
-180 |                  ┗━━━━━━    ← 高频渐近线
     └─────────────────────────▶ 频率(Hz)
```

**数值示例**（BW = 5MHz）：

| 调制频率 | 输入幅度 | 输出幅度 | 衰减(dB) | 相位滞后(°) |
|---------|---------|---------|---------|-----------|
| 100 kHz | 20ps | 19.8ps | -0.17 | -5 |
| 1 MHz | 20ps | 18.5ps | -0.66 | -20 |
| 5 MHz | 20ps | 14.1ps | -3.0 | -90 |
| 10 MHz | 20ps | 10.0ps | -6.0 | -135 |
| 50 MHz | 20ps | 2.8ps | -17.0 | -175 |

**验证方法**：
```bash
python scripts/measure_loop_bandwidth.py cdr_tran_track.csv
```

脚本自动计算：
- -3dB带宽
- 相位裕度（PM）
- 增益裕度（GM）

**验证标准**：
- [ ] -3dB带宽与理论值接近（误差 < 20%）
- [ ] 相位裕度 > 45°（稳定性要求）
- [ ] 无谐振峰值（阻尼充分）

#### 5.2.5 LOOP_BANDWIDTH - 环路带宽精确测量

**测试配置**：
- 多组PI参数对比
- 调制频率：10kHz ~ 100MHz（每倍频10个点）
- 调制幅度：固定20ps（线性范围）

**理论计算对比**：

| 配置 | Kp | Ki | 理论BW (MHz) | 理论ζ | 实测BW (MHz) | 实测ζ | 误差(%) |
|-----|----|----|-------------|-------|-------------|-------|--------|
| 1 | 0.005 | 2.5e-5 | 2.51 | 0.707 | 2.38 | 0.72 | -5.2 |
| 2 | 0.01 | 1e-4 | 5.03 | 0.707 | 4.87 | 0.69 | -3.2 |
| 3 | 0.02 | 4e-4 | 10.05 | 0.707 | 9.65 | 0.71 | -4.0 |

> **说明**：理论值基于线性化模型，实测值因Bang-Bang PD的非线性略有偏差（通常5~10%）。

**Bode图绘制**：

```bash
python scripts/plot_bode.py cdr_tran_bw.csv
```

生成双子图：
- 上图：幅频响应（dB vs Hz，对数刻度）
- 下图：相频响应（degree vs Hz，对数刻度）

标注关键点：
- -3dB带宽频率
- 相位裕度（PM）
- 增益交叉频率

**验证标准**：
- [ ] 实测带宽与理论值误差 < 20%
- [ ] 不同参数配置的带宽比例符合预期（如Kp加倍，BW应增加约41%）
- [ ] 相位裕度 > 45°（所有配置）

### 5.3 波形数据文件格式

#### 5.3.1 相位波形文件（cdr_tran_*.csv）

**主要输出**：CDR相位调整信号的时域波形。

**文件格式**：

```csv
时间(s), 相位输出(s), 相位输出(ps), 相位输出(UI), 相位误差(ps)
0.000000e+00, 0.000000e+00, 0.00, 0.000, 0.00
1.000000e-10, 1.234567e-11, 12.35, 0.123, -5.67
2.000000e-10, 2.456789e-11, 24.57, 0.246, -3.45
...
```

**列说明**：
- **时间(s)**：仿真时间戳
- **相位输出(s)**：CDR输出的相位调整量（单位：秒）
- **相位输出(ps)**：相位输出的皮秒表示（便于阅读）
- **相位输出(UI)**：相位输出的UI表示（归一化）
- **相位误差(ps)**：相位输出与理想相位的差值（如果已知理想相位）

**采样率**：
- 默认：每UI一个数据点
- 高分辨率模式：每UI 10个采样点（用于观察细节）

**文件大小估算**：
- 10,000 UI @ 1列/UI ≈ 10,000行 ≈ 500KB
- 50,000 UI @ 10列/UI ≈ 500,000行 ≈ 25MB

#### 5.3.2 BER统计文件（cdr_ber_summary.json）

**输出**：综合性能指标的JSON格式汇总。

**文件格式**：

```json
{
  "test_scenario": "PHASE_LOCK_BASIC",
  "simulation_params": {
    "data_rate_gbps": 10,
    "ui_ps": 100,
    "simulation_time_us": 1.0,
    "total_bits": 10000000
  },
  "cdr_params": {
    "kp": 0.01,
    "ki": 0.0001,
    "pai_range_ps": 1.0,
    "pai_resolution_ps": 0.01
  },
  "phase_statistics": {
    "lock_time_ui": 2345,
    "lock_time_us": 0.2345,
    "steady_state_mean_ps": 0.23,
    "steady_state_rms_ps": 2.87,
    "steady_state_pk2pk_ps": 11.5,
    "max_phase_error_ps": 15.2
  },
  "ber_statistics": {
    "total_errors": 0,
    "ber": 0.0,
    "q_factor": null,
    "q_factor_db": null
  },
  "loop_performance": {
    "bandwidth_measured_mhz": 4.87,
    "bandwidth_theoretical_mhz": 5.03,
    "phase_margin_deg": 52.3,
    "damping_factor": 0.69
  },
  "status": "PASSED",
  "notes": "Locked successfully, no bit errors detected."
}
```

**关键字段说明**：
- **phase_statistics.lock_time_ui**：锁定时间（UI）
- **phase_statistics.steady_state_rms_ps**：稳态抖动RMS（ps）
- **ber_statistics.ber**：误码率
- **loop_performance.bandwidth_measured_mhz**：实测环路带宽
- **loop_performance.phase_margin_deg**：相位裕度
- **status**：测试结果（PASSED/FAILED/WARNING）

#### 5.3.3 JTOL数据文件（cdr_jtol.csv）

**输出**：抖动容限测试的频率扫描结果。

**文件格式**：

```csv
抖动频率(Hz), 抖动幅度(ps), 抖动幅度(UI), BER, 测试时长(UI), 误码数
1.00e+03, 100.0, 1.000, 1.23e-15, 1000000, 0
1.00e+04, 98.5, 0.985, 5.67e-13, 1000000, 0
1.00e+05, 95.2, 0.952, 1.02e-12, 1000000, 1
1.00e+06, 80.3, 0.803, 9.87e-13, 1000000, 0
5.00e+06, 70.7, 0.707, 1.05e-12, 1000000, 1
1.00e+07, 50.1, 0.501, 9.65e-13, 1000000, 0
5.00e+07, 30.5, 0.305, 1.12e-12, 1000000, 1
1.00e+08, 30.2, 0.302, 8.94e-13, 1000000, 0
```

**后处理示例**：

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np

# 读取JTOL数据
df = pd.read_csv('cdr_jtol.csv')

# 绘制JTOL曲线
plt.figure(figsize=(10, 6))
plt.semilogx(df['抖动频率(Hz)'], df['抖动幅度(UI)'], 'o-', linewidth=2)
plt.xlabel('Jitter Frequency (Hz)')
plt.ylabel('Jitter Tolerance (UI)')
plt.title('CDR Jitter Tolerance Curve')
plt.grid(True, which='both', alpha=0.3)

# 标注-3dB点
bw_idx = np.argmin(np.abs(df['抖动幅度(UI)'] - 0.707))
bw_freq = df['抖动频率(Hz)'].iloc[bw_idx]
plt.axvline(bw_freq, color='r', linestyle='--', label=f'BW ≈ {bw_freq/1e6:.1f} MHz')

# 标注低频高频区域
plt.axhline(1.0, color='g', linestyle=':', alpha=0.5, label='Full Tracking')
plt.axhline(0.3, color='b', linestyle=':', alpha=0.5, label='Intrinsic Tolerance')

plt.legend()
plt.tight_layout()
plt.savefig('jtol_curve.png', dpi=300)
plt.show()
```

#### 5.3.4 调试日志文件（cdr_debug.log）

**输出**：仅在debug模式下生成，包含逐周期的内部状态。

**文件格式**（文本格式，便于grep）：

```
[时间=1.000e-10] PD输入=1, PD输出=1, 比例项=0.010, 积分项=0.001, 相位输出=0.011
[时间=2.000e-10] PD输入=0, PD输出=-1, 比例项=-0.010, 积分项=0.001, 相位输出=-0.009
[时间=3.000e-10] PD输入=1, PD输出=1, 比例项=0.010, 积分项=0.002, 相位输出=0.012
...
```

**用途**：
- 诊断相位检测器输出是否正确
- 验证PI控制器的比例项和积分项分离
- 检查相位限幅器的工作状态

**启用方法**：
```bash
./cdr_tran_tb lock --debug
```

---

## 6. 运行指南

### 6.1 环境配置

运行测试前需要配置环境变量：

```bash
source scripts/setup_env.sh
```

或手动设置：
```bash
export SYSTEMC_HOME=/usr/local/systemc-2.3.4
export SYSTEMC_AMS_HOME=/usr/local/systemc-ams-2.3.4
```

验证环境配置：
```bash
echo $SYSTEMC_HOME       # 应输出 SystemC 安装路径
echo $SYSTEMC_AMS_HOME   # 应输出 SystemC-AMS 安装路径
```

### 6.2 构建与运行

```bash
# 创建构建目录并编译
mkdir -p build && cd build
cmake ..
make cdr_tran_tb

# 运行测试（在 tb 目录下）
cd tb
./cdr_tran_tb [scenario]
```

场景参数：
| 参数 | 编号 | 说明 |
|------|------|------|
| `PHASE_LOCK_BASIC` | `0` | 基本功能测试（默认） |
| `LOOP_BANDWIDTH` | `1` | PI参数扫描测试 |
| `FREQUENCY_OFFSET` | `2` | 频率偏移捕获测试 |
| `JITTER_TOLERANCE` | `3` | 抖动容限测试 |
| `PHASE_TRACKING` | `4` | 动态相位跟踪测试 |

运行示例：
```bash
# 运行基本功能测试
./cdr_tran_tb PHASE_LOCK_BASIC

# 运行PI参数扫描
./cdr_tran_tb LOOP_BANDWIDTH

# 运行全部场景（批量测试）
for i in 0 1 2 3 4; do ./cdr_tran_tb $i; done
```

### 6.3 参数配置示例

CDR模块支持通过JSON配置文件进行参数化。以下是针对不同应用场景的快速启动配置。

#### 快速验证配置（标准带宽）

适用于初步功能验证和调试，环路带宽约5MHz：

```json
{
  "cdr": {
    "pi": {
      "kp": 0.01,
      "ki": 1e-4
    },
    "pai": {
      "resolution": 1e-12,
      "range": 5e-11
    }
  }
}
```

**特点**：
- 环路带宽适中（约5MHz），平衡跟踪速度和稳定性
- 相位分辨率1ps，适用于中高端SerDes
- 相位范围±25ps，足以应对中等频偏（<500ppm）

#### 高带宽配置（快速锁定）

适用于需要快速锁定的场景（如频繁链路重训练），环路带宽约10MHz：

```json
{
  "cdr": {
    "pi": {
      "kp": 0.02,
      "ki": 4e-4
    },
    "pai": {
      "resolution": 1e-12,
      "range": 1e-10
    }
  }
}
```

**特点**：
- 较大的Kp/Ki加快锁定速度（锁定时间<1000 UI）
- 更大的相位范围±50ps，容纳更大频偏（<1000ppm）
- 代价：锁定抖动略高（2~5ps RMS）

**适用场景**：
- 链路训练阶段
- 频繁进入/退出低功耗模式
- 参考时钟频偏较大的系统

#### 低抖动配置（高稳定性）

适用于要求低抖动的数据传输阶段，环路带宽约2MHz：

```json
{
  "cdr": {
    "pi": {
      "kp": 0.005,
      "ki": 2.5e-5
    },
    "pai": {
      "resolution": 5e-13,
      "range": 3e-11
    }
  }
}
```

**特点**：
- 较低的环路带宽减少相位抖动（<2ps RMS）
- 更高的相位分辨率0.5ps提升精度
- 代价：锁定时间较长（>3000 UI）

**适用场景**：
- 数据传输稳态阶段
- 高质量信道（低抖动环境）
- 对BER极其敏感的应用

#### 宽频偏适应配置（双环架构仿真）

适用于大频偏场景（>1000ppm），需要宽相位范围：

```json
{
  "cdr": {
    "pi": {
      "kp": 0.015,
      "ki": 2e-4
    },
    "pai": {
      "resolution": 2e-12,
      "range": 2e-10
    }
  }
}
```

**特点**：
- 极宽的相位范围±100ps，容纳极端频偏（<2000ppm @ 10Gbps）
- 平衡的PI参数兼顾速度和稳定性
- 适度放宽分辨率至2ps降低计算开销

**适用场景**：
- 参考时钟质量差的系统
- 跨时钟域系统级仿真
- 压力测试和频偏容限验证

#### 自定义参数调优指南

根据实际需求调整参数时，参考以下准则：

**环路带宽目标**：
```
理论带宽估算：BW ≈ √(Ki) / (2π)  [Hz]
调整策略：
  - 提高BW：同时增大Kp和Ki（保持 Ki ≈ Kp²）
  - 降低BW：同时减小Kp和Ki
```

**阻尼系数目标**：
```
推荐范围：ζ = 0.7 ~ 1.0（避免振荡）
调整策略：
  - 若出现振荡：增大Kp（提升阻尼）
  - 若响应过慢：减小Kp（降低阻尼）
```

**相位范围估算**：
```
最小范围需求：range ≥ |freq_offset(ppm)| × 1e-6 × UI × 10000
示例：500ppm @ 10Gbps (UI=100ps) → range ≥ 50ps
```

**分辨率选择**：
```
经验法则：resolution = UI / 64 ~ UI / 256
  - 高端实现：UI/256 (约0.4ps @ 10Gbps)
  - 中端实现：UI/128 (约0.8ps @ 10Gbps)
  - 低成本实现：UI/64 (约1.6ps @ 10Gbps)
```

### 6.4 结果查看

测试完成后，控制台输出关键性能指标（锁定时间、相位误差统计、锁定抖动等），波形数据保存到`.dat`文件。

#### 波形可视化

使用Python脚本进行波形绘制和分析：

```bash
# 基本波形可视化（相位误差、PI输出）
python scripts/plot_cdr_waveform.py --input tb/cdr_basic_phase.dat

# 频谱分析（相位抖动PSD）
python scripts/plot_cdr_psd.py --input tb/cdr_basic_phase.dat

# 多场景对比（PI参数扫描结果）
python scripts/plot_cdr_sweep.py --dir tb/cdr_sweep_results/
```

**输出文件命名规范**：
- `cdr_[scenario]_phase.dat`：相位输出时域波形
- `cdr_[scenario]_error.dat`：相位误差时域波形
- `cdr_[scenario]_stats.json`：统计指标（均值、RMS、锁定时间）

#### 关键指标解读

控制台输出示例：
```
=== CDR Performance Statistics ===
Lock Time:        2345 UI (234.5 ns)
Phase Error (locked):
  Mean:           0.12 ps
  Std Dev (RMS):  1.8 ps
  Peak-to-Peak:   12.3 ps
Phase Output Range:
  Min:            -15.2 ps
  Max:            +14.8 ps
  Utilization:    60.0% of ±25ps range
BER (if available): 1.2e-13
```

**指标判断准则**：
- **Lock Time < 3000 UI**：锁定速度合格
- **RMS < 5ps**：锁定抖动良好（Bang-Bang PD典型值）
- **Mean ≈ 0ps**：无静态相位偏移（PI积分有效）
- **Utilization < 80%**：相位范围裕量充足

#### 问题诊断指南

| 现象 | 可能原因 | 解决方案 |
|------|----------|----------|
| 无法锁定（相位发散） | Kp/Ki过大导致不稳定 | 减小Kp/Ki，检查阻尼系数 |
| 锁定时间过长 | Kp/Ki过小 | 增大Kp/Ki，但保持ζ>0.5 |
| 锁定抖动过大 | 环路带宽过高 | 减小Kp/Ki降低带宽 |
| 相位范围耗尽 | 频偏过大或range不足 | 增大pai.range，检查频偏 |
| 相位误差有直流偏移 | Ki过小无法消除静差 | 增大Ki（保持Ki≈Kp/10） |

---

## 7. 技术要点

### 7.1 环路稳定性设计

CDR环路是典型的反馈控制系统，稳定性设计至关重要：

**二阶系统特性**：

PI控制器构成二阶环路，其阻尼系数ζ决定稳定性：
- **ζ < 0.5**：欠阻尼，快速响应但有过冲和振荡
- **ζ = 0.707**：临界阻尼，最快无过冲响应（最优）
- **ζ > 1.0**：过阻尼，无过冲但响应慢

**Kp和Ki的关系**：

给定目标阻尼系数ζ和环路带宽BW，反推PI参数：
```
ωn = 2π × BW
Ki = ωn² / Fs
Kp = 2 × ζ × ωn
```

> ⚠️ **示例计算的注意事项**：
> 
> 以下示例计算基于**线性相位检测器**的连续域模型推导，但本模块使用的是**Bang-Bang相位检测器**，其非线性特性导致实际参数需要调整。以下公式仅供**初步估算**，实际设计需通过仿真验证。
>
> **示例计算**（10Gbps系统，目标BW=5MHz，ζ=0.707）：
> ```
> ωn = 2π × 5e6 = 3.14e7 rad/s
> Ki = (3.14e7)² / 10e9 = 9.8e-5
> Kp = 2 × 0.707 × 3.14e7 / 10e9 = 0.0044
> ```
> 
> **或者**，如需删除此计算示例以避免混淆，可直接提醒用户：
> "由于Bang-Bang PD的非线性特性，建议通过SystemC-AMS仿真调优Kp/Ki参数，而非依赖线性化公式。"

### 7.2 Bang-Bang PD的抖动性能

Bang-Bang相位检测器的离散特性会引入环路抖动：

**随机抖动（RJ）来源**：
- PD输出为离散的±1，缺乏线性区间
- 每次更新都是"过校正"，导致相位在最佳点附近抖动
- 抖动幅度与环路增益成正比：σφ ≈ √(Kp / Fs)

**降低抖动的方法**：
1. 降低环路带宽（减小Kp/Ki）
2. 使用线性相位检测器（如Hogge PD）替代Bang-Bang PD
3. 增加相位检测器分辨率（多级量化）

**Bang-Bang PD的优势**：
- 结构简单，硬件开销小
- 对输入信号幅度不敏感
- 适用于高速链路（40Gbps+）

### 7.3 相位插值器分辨率选择

相位插值器分辨率影响CDR的精度和硬件成本：

**分辨率与UI的关系**：

典型设计中，相位插值器分辨率为UI的1/64~1/256：
- **高精度**（UI/256）：σφ < 0.5ps，适用于56G/112G PAM4
- **中等精度**（UI/128）：σφ ≈ 1ps，适用于10G/25G NRZ
- **低精度**（UI/64）：σφ ≈ 2ps，适用于低成本应用

**默认值选择**（1ps）：

项目默认1ps（1e-12秒）对应UI/100（假设10Gbps，UI=100ps）：
- 提供足够的相位调整精度
- 模拟中高端SerDes实现
- 可通过配置调整为更粗糙的分辨率（5ps）模拟低成本方案

**量化噪声**：

分辨率越粗，量化噪声越大：
```
σ_quantization ≈ resolution / √12
```
对于1ps分辨率，量化噪声约0.29ps RMS。

### 7.4 与采样器模块的接口设计

CDR的`phase_out`端口必须与采样器的`phase_offset`端口正确连接：

**单位约定**：

- CDR输出：时间偏移量，单位**秒（s）**
- 采样器接收：相位偏移量，单位**秒（s）**
- 物理含义：正值延迟采样，负值提前采样

**时序协调**：

CDR和采样器工作在相同的采样率（Fs），确保：
```cpp
// 两者必须设置相同采样率
cdr.set_attributes() {
    in.set_rate(1);
    phase_out.set_rate(1);
}

sampler.set_attributes() {
    phase_offset.set_rate(1);
    // ...
}
```

**相位更新延迟**：

实际硬件中，CDR相位更新到采样器有延迟（1~2个周期），当前模型未考虑此延迟。若需要更精确建模，可在CDR模块内部增加延迟缓冲器。

### 7.5 频率捕获（待实现功能）

当前版本未实现频率捕获功能，仅适用于发送端和接收端频率已近似匹配的场景（频偏 < ±100ppm）。

**频率检测器的必要性**：

实际SerDes中，参考时钟频偏可达±100ppm，对应10Gbps系统为±1MHz。若仅靠相位环路跟踪，会导致：
- 相位累积量持续增大，超出相位插值器范围
- 环路无法锁定

**频率辅助方案**（未来版本）：

1. **旋转频率检测器**（Rotational Frequency Detector）：
   - 监测相位累积量的变化率
   - 输出频率误差信号到VCO或PLL

2. **双环架构**：
   - 低带宽频率环（kHz级）：跟踪频偏
   - 高带宽相位环（MHz级）：跟踪抖动

3. **锁定检测器**：
   - 监测相位误差的方差
   - 当方差小于阈值时，声明锁定

### 7.6 采样率要求

CDR模块的采样率必须与数据速率匹配：

**推荐设置**：

对于baud-rate CDR（每个符号一次相位更新）：
```cpp
// SystemC-AMS TDF模块采样率设置
void RxCdrTdf::set_attributes() {
    set_timestep(UI);  // 采样时间步长 = 单位间隔
}
```

对于10Gbps NRZ（UI=100ps）：
- CDR采样率 = 10 GHz
- 每个比特触发一次相位检测和环路更新

**过采样CDR**（未来扩展）：

某些CDR设计使用2×或4×过采样以提高相位检测精度，但会增加功耗和复杂度。

### 7.7 已知限制与注意事项

**限制1 - 相位检测精度**：

当前实现采用边沿极性检测，相位检测精度有限。实际应用中可替换为完整的BBPD实现以提高精度。

**限制2 - 频率捕获能力**：

无法处理大频偏情况（>±100ppm）。若需要模拟参考时钟频偏，需先手动调整PLL模块的输出频率，或在后续版本中增加频率检测器。

**限制3 - 无锁定检测**：

模块不输出锁定状态信号，无法判断CDR是否成功锁定。建议在测试平台中监测`phase_out`信号的方差。

**限制4 - 线性相位范围**：

当相位累积量超出±range时，会硬限幅，导致暂时失去跟踪能力。实际设计中应通过频率检测器避免此情况。

**注意事项**：

- 调整Kp/Ki时，需同时检查阻尼系数和带宽，避免不稳定
- 相位范围应大于预期最大频偏 × UI
- Bang-Bang PD在低信噪比时性能下降，建议配合DFE使用

---

## 8. 参考信息

### 8.1 相关文件

| 文件类型 | 路径 | 说明 |
|---------|------|------|
| 参数定义 | `/include/common/parameters.h` | RxCdrParams结构体（PI/PAI参数） |
| 头文件 | `/include/ams/rx_cdr.h` | RxCdrTdf类声明 |
| 实现文件 | `/src/ams/rx_cdr.cpp` | RxCdrTdf类实现 |
| 测试平台 | `/tb/rx/cdr/cdr_tran_tb.cpp` | CDR瞬态测试平台 |
| 测试辅助 | `/tb/rx/cdr/cdr_helpers.h` | 测试平台辅助函数 |
| 默认配置 | `/config/default.json` | 全局配置文件（cdr章节） |

### 8.2 依赖项

**编译时依赖**：
- SystemC 2.3.4
- SystemC-AMS 2.3.4
- C++14标准

**运行时依赖**：
- 上游模块：Sampler（`RxSamplerTdf`）提供数据采样值和边沿采样值
- 下游模块：BER分析模块或误码统计模块（用于评估CDR性能）

**系统级依赖**：
- 参考时钟源：通常由时钟生成模块（`ClockGenTdf`）提供
- DFE模块：CDR输出的恢复时钟用于驱动DFE抽头更新

### 8.3 配置示例

#### 基本配置（标准5MHz带宽）

```json
{
  "cdr": {
    "pi": {
      "kp": 0.01,
      "ki": 1e-4
    },
    "pai": {
      "resolution": 1e-12,
      "range": 5e-11
    }
  }
}
```

**参数说明**：
- `kp = 0.01`：比例增益，控制环路响应速度
- `ki = 1e-4`：积分增益，消除稳态相位误差
- `resolution = 1ps`：相位插值器最小调整步长
- `range = 50ps`：相位可调范围（约0.5 UI @ 10Gbps）

#### 快速锁定配置（10MHz带宽）

```json
{
  "cdr": {
    "pi": {
      "kp": 0.02,
      "ki": 4e-4
    },
    "pai": {
      "resolution": 2e-12,
      "range": 1e-10
    }
  }
}
```

**应用场景**：
- 突发模式通信（Burst-mode）
- 频繁链路切换（Link training）
- 需要快速捕获的系统（Fast acquisition）

#### 低抖动配置（2MHz带宽）

```json
{
  "cdr": {
    "pi": {
      "kp": 0.004,
      "ki": 1.6e-5
    },
    "pai": {
      "resolution": 0.5e-12,
      "range": 3e-11
    }
  }
}
```

**应用场景**：
- 低抖动要求的系统（Jitter-sensitive applications）
- 高信噪比信道（Clean channels）
- 时钟抖动传递抑制（Jitter transfer reduction）

#### 宽频偏容忍配置（大范围捕获）

```json
{
  "cdr": {
    "pi": {
      "kp": 0.015,
      "ki": 2e-4
    },
    "pai": {
      "resolution": 2e-12,
      "range": 2e-10
    }
  }
}
```

**应用场景**：
- 发送端和接收端时钟频率偏差较大（>±200ppm）
- 需要宽频偏捕获的系统（Wide frequency acquisition）
- 无频率检测器辅助的纯相位环路

### 8.4 参数调优指南

#### 环路带宽（BW）与Kp/Ki的关系

给定目标环路带宽BW和阻尼系数ζ，可估算PI参数：

```
ωn = 2π × BW
Ki = ωn² × UI / Fs
Kp = 2 × ζ × ωn × UI / Fs
```

其中：
- UI为单位间隔时间（秒），例如10Gbps系统中UI=100ps
- Fs为相位累加器的更新频率（Hz）
- 此公式**适用于Bang-Bang PD的数字CDR**（Kpd=1/UI）

**推荐阻尼系数**：
- ζ = 0.707（临界阻尼）：最快无过冲响应
- ζ = 0.8-1.0（轻度过阻尼）：牺牲10-20%速度换取更好稳定性

> ⚠️ **重要说明**：
> - 对于其他类型的相位检测器，需根据实际Kpd和Kvco值调整公式
> - 对于线性PD（Kpd≠1/UI），需要将公式中的UI替换为Kpd
> - Bang-Bang PD的非线性特性会导致实际参数需要微调，建议将公式结果作为**初值**，通过SystemC-AMS仿真优化

#### 相位调整范围（PAI range）设计

```
range_min = 2 × (频偏ppm × UI) + 相位余量
```

**示例**（10Gbps系统，±300ppm频偏）：
```
频偏引起的相位偏差 = 300e-6 × 100ps = 30ps
推荐range = 2 × 30ps + 20ps = 80ps
```

#### 相位插值器分辨率（PAI resolution）权衡

| 分辨率 | 量化相位误差 | 环路抖动 | 硬件成本 |
|--------|-------------|---------|---------|
| 0.5ps  | ±0.25ps     | 低      | 高（8-9 bit） |
| 1ps    | ±0.5ps      | 中      | 中（7-8 bit） |
| 2ps    | ±1ps        | 高      | 低（6-7 bit） |

**推荐**：对于10-28Gbps SerDes，1ps分辨率是性能和成本的良好平衡点。

### 8.5 常见问题与解决方案

| 问题现象 | 可能原因 | 解决方法 |
|---------|---------|---------|
| CDR无法锁定 | Kp/Ki过大，环路振荡 | 减小Kp和Ki，增加阻尼系数ζ |
| 锁定速度过慢 | Kp/Ki过小，环路带宽不足 | 增大Kp和Ki，但保持ζ > 0.5 |
| 锁定后抖动过大 | 环路带宽过高 | 减小环路带宽（降低Kp/Ki） |
| 相位调整范围耗尽 | 频偏超出PAI range | 增大range参数或加入频率检测器 |
| 周期性相位跳变 | PAI resolution不足 | 减小resolution或改用线性PD |
| 直流相位偏移 | Ki过小，积分不充分 | 增大Ki，增强直流增益 |

### 8.6 与相关模块的接口关系

**上游模块**：
- **Sampler**：提供`data_sample`（数据采样值）和`edge_sample`（边沿采样值），CDR据此计算相位误差
- **DFE**：提供均衡后的信号质量，影响相位检测精度

**下游模块**：
- **解串器**（Deserializer）：使用CDR输出的`recovered_clock`进行串并转换
- **BER测试模块**：使用恢复时钟评估误码率性能

**系统级交互**：
- **时钟生成模块**：提供参考时钟基准（频率约为数据速率的1/4或1/2）
- **自适应算法**：DFE自适应、AGC自适应通常需要CDR锁定后再启动

---

**文档版本**：v0.2  
**最后更新**：2026-01-20  
**作者**：Qoder serdes-doc-writer