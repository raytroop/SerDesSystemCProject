# VGA 模块技术文档

🌐 **Languages**: [中文](vga.md) | [English](../en/modules/vga.md)

**级别**：AMS 子模块（RX）  
**类名**：`RxVgaTdf`  
**当前版本**：v0.1 (2025-12-07)  
**状态**：生产就绪

---

## 1. 概述

可变增益放大器（VGA）是SerDes接收端的关键模拟前端模块，位于CTLE之后，主要功能是提供可配置的信号增益，用于自动增益控制（AGC）环路中动态调整信号幅度，确保后级采样器接收到适当的信号电平。

### 1.1 设计原理

VGA的核心设计思想是利用零极点传递函数实现可调节的信号放大：

- **可变增益**：通过`dc_gain`参数实现增益的动态调节，适用于AGC自适应控制
- **频率整形**：通过配置零点和极点，可以实现频率选择性的增益特性
- **带宽限制**：通过极点频率控制放大器带宽，避免高频噪声过度放大

传递函数的数学形式为：
```
H(s) = dc_gain × ∏(1 + s/ωz_i) / ∏(1 + s/ωp_j)
```
其中 ωz = 2π×fz（零点角频率），ωp = 2π×fp（极点角频率）。

### 1.2 核心特性

- **差分架构**：完整的差分信号路径，支持共模抑制
- **灵活传递函数**：支持任意多零点/多极点配置
- **可变增益**：通过`dc_gain`参数实现增益调节，适用于AGC环路
- **非理想效应建模**：输入偏移、输入噪声、输出软饱和
- **PSRR建模**：电源噪声通过可配置传递函数耦合到输出
- **CMFB环路**：共模反馈环路，稳定输出共模电压
- **CMRR建模**：输入共模到差分输出的泄漏路径

### 1.3 版本历史

| 版本 | 日期 | 主要变更 |
|------|------|----------|
| v0.1 | 2025-12-07 | 初始版本，参照CTLE模块架构，差分接口，支持PSRR/CMFB/CMRR |

---

## 2. 模块接口

### 2.1 端口定义（TDF域）

| 端口名 | 方向 | 类型 | 说明 |
|-------|------|------|------|
| `in_p` | 输入 | double | 差分输入正端 |
| `in_n` | 输入 | double | 差分输入负端 |
| `vdd` | 输入 | double | 电源电压（PSRR建模用） |
| `out_p` | 输出 | double | 差分输出正端 |
| `out_n` | 输出 | double | 差分输出负端 |

> **重要**：即使不启用PSRR功能，`vdd`端口也必须连接（SystemC-AMS要求所有端口均需连接）。

### 2.2 参数配置（RxVgaParams）

#### 基本参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `dc_gain` | double | 2.0 | 直流增益（线性倍数） |
| `zeros` | vector&lt;double&gt; | [1e9] | 零点频率列表（Hz） |
| `poles` | vector&lt;double&gt; | [20e9] | 极点频率列表（Hz） |
| `vcm_out` | double | 0.6 | 差分输出共模电压（V） |
| `offset_enable` | bool | false | 启用输入偏移 |
| `vos` | double | 0.0 | 输入偏移电压（V） |
| `noise_enable` | bool | false | 启用输入噪声 |
| `vnoise_sigma` | double | 0.0 | 噪声标准差（V，高斯分布） |
| `sat_min` | double | -0.5 | 输出最小电压（V） |
| `sat_max` | double | 0.5 | 输出最大电压（V） |

#### PSRR子结构

电源抑制比路径，建模VDD纹波对差分输出的影响。

| 参数 | 说明 |
|------|------|
| `enable` | 启用PSRR建模 |
| `gain` | PSRR路径增益（如0.01表示-40dB） |
| `poles` | 低通滤波极点频率 |
| `vdd_nom` | 名义电源电压 |

工作原理：`vdd_ripple = vdd - vdd_nom` → PSRR传递函数 → 耦合到差分输出

#### CMFB子结构

共模反馈环路，稳定输出共模电压到目标值。

| 参数 | 说明 |
|------|------|
| `enable` | 启用CMFB环路 |
| `bandwidth` | 环路带宽（Hz） |
| `loop_gain` | 环路增益 |

工作原理：测量输出共模 → 与目标比较 → 环路滤波器 → 调整共模

#### CMRR子结构

共模抑制比路径，建模输入共模到差分输出的泄漏。

| 参数 | 说明 |
|------|------|
| `enable` | 启用CMRR建模 |
| `gain` | CM→DIFF泄漏增益 |
| `poles` | 低通滤波极点频率 |

---

## 3. 核心实现机制

### 3.1 信号处理流程

VGA模块的`processing()`方法采用严格的多步骤流水线处理架构，确保信号处理的正确性和可维护性：

```
输入读取 → 偏移注入 → 噪声注入 → VGA滤波 → 软饱和 → PSRR路径 → CMRR路径 → 合成 → CMFB → 输出
```

**步骤1-输入读取**：从差分输入端口读取信号，计算差分分量 `vin_diff = in_p - in_n` 和共模分量 `vin_cm = 0.5*(in_p + in_n)`。

**步骤2-偏移注入**：若启用`offset_enable`，将直流偏移电压`vos`叠加到差分信号，模拟实际放大器的失配引起的偏移。

**步骤3-噪声注入**：若启用`noise_enable`，采用Mersenne Twister随机数生成器产生高斯分布噪声，标准差由`vnoise_sigma`指定。

**步骤4-VGA核心滤波**：这是VGA的核心功能。如果配置了零极点，使用SystemC-AMS的`sca_tdf::sca_ltf_nd`滤波器应用传递函数；否则直接应用DC增益。

**步骤5-软饱和**：使用双曲正切函数`tanh(x/Vsat)*Vsat`实现平滑饱和，避免硬限幅带来的谐波失真，更真实地模拟模拟电路行为。

**步骤6-PSRR路径**：若启用，计算VDD偏离名义值的纹波，通过PSRR传递函数处理后耦合到差分输出。

**步骤7-CMRR路径**：若启用，输入共模信号通过CMRR传递函数后泄漏到差分输出。

**步骤8-差分合成**：将主通道、PSRR路径、CMRR路径的贡献累加，形成总差分输出。

**步骤9-CMFB处理**：若启用共模反馈，测量前一周期的输出共模（避免代数环），与目标共模比较并通过环路滤波器调整。

**步骤10-输出生成**：基于有效共模电压和差分信号生成差分输出：`out_p = vcm + 0.5*vdiff`，`out_n = vcm - 0.5*vdiff`。

### 3.2 传递函数构建机制

模块采用动态多项式卷积方法构建任意阶数的传递函数：

1. **初始化**：分子多项式以DC增益为常数项，分母为1
2. **零点处理**：对每个零点频率fz，分子与`(1 + s/ωz)`卷积
3. **极点处理**：对每个极点频率fp，分母与`(1 + s/ωp)`卷积
4. **系数转换**：将多项式系数转换为`sca_util::sca_vector`格式

多项式系数布局采用升幂顺序：`[a0, a1, a2, ...]` 表示 `a0 + a1*s + a2*s² + ...`

### 3.3 软饱和设计思想

传统的硬限幅会引入丰富的谐波分量，不符合实际模拟电路行为。本模块采用`tanh`函数实现软饱和：

- 当输入远小于饱和电压Vsat时，输出近似线性
- 当输入接近Vsat时，增益渐进压缩
- 输出渐近地趋近±Vsat，但永不达到

这种设计更精确地模拟了跨导级对输出摆幅的自然限制。

---

## 4. 测试平台架构

### 4.1 测试平台设计思想

VGA测试平台（`VgaTransientTestbench`）采用模块化设计，支持多种测试场景的统一管理。核心设计理念：

1. **场景驱动**：通过枚举类型选择不同测试场景，每个场景自动配置相应的信号源和VGA参数
2. **组件复用**：差分信号源、VDD源、信号监控器等辅助模块可复用
3. **结果分析**：根据场景类型自动选择合适的分析方法

### 4.2 测试场景定义

测试平台支持五种核心测试场景：

| 场景 | 命令行参数 | 测试目标 | 输出文件 |
|------|----------|---------|----------|
| BASIC_PRBS | `prbs` / `0` | 基本信号传输和增益特性 | vga_tran_prbs.csv |
| FREQUENCY_RESPONSE | `freq` / `1` | 频率响应特性 | vga_tran_freq.csv |
| PSRR_TEST | `psrr` / `2` | 电源抑制比测试 | vga_tran_psrr.csv |
| CMRR_TEST | `cmrr` / `3` | 共模抑制比测试 | vga_tran_cmrr.csv |
| SATURATION_TEST | `sat` / `4` | 大信号饱和测试 | vga_tran_sat.csv |

### 4.3 场景配置详解

#### BASIC_PRBS - 基本PRBS测试

验证VGA基本的差分信号传输和DC增益特性。

- **信号源**：PRBS-7伪随机序列
- **输入幅度**：100mV
- **符号率**：10 Gbps
- **共模电压**：0.6V
- **VDD**：1.0V稳定电源
- **仿真时间**：100ns
- **验证点**：输出幅度 ≈ 输入幅度 × DC增益

#### FREQUENCY_RESPONSE - 频率响应测试

验证VGA在特定频率下的响应特性。

- **信号源**：正弦波
- **测试频率**：5 GHz
- **输入幅度**：100mV
- **仿真时间**：1μs（覆盖5000个周期）
- **验证点**：在零极点频率附近，增益应符合传递函数特性

#### PSRR_TEST - 电源抑制比测试

验证VDD纹波对差分输出的影响。

- **差分输入**：DC（无差分信号）
- **VDD纹波**：100mV @ 1MHz正弦波
- **PSRR增益**：0.01（-40dB）
- **PSRR极点**：1MHz
- **仿真时间**：必须≥3μs（覆盖3个完整周期）
- **验证点**：输出差分纹波幅度应远小于VDD纹波

#### CMRR_TEST - 共模抑制比测试

验证输入共模变化对差分输出的影响。

- **差分输入**：100mV小差分信号
- **CMRR增益**：0.001（-60dB）
- **CMRR极点**：10MHz
- **仿真时间**：3μs
- **验证点**：输出中共模泄漏分量应符合设定CMRR

#### SATURATION_TEST - 饱和测试

验证VGA在大信号输入下的饱和行为。

- **信号源**：方波
- **输入幅度**：500mV（大信号）
- **频率**：1 GHz
- **仿真时间**：100ns
- **验证点**：输出幅度应受限于sat_min/sat_max范围

### 4.4 信号连接拓扑

测试平台的模块连接关系如下：

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│ DiffSignalSource  │       │    RxVgaTdf      │       │  SignalMonitor  │
│                   │       │                   │       │                   │
│  out_p ───────────┼───────▶ in_p             │       │                   │
│  out_n ───────────┼───────▶ in_n             │       │                   │
└─────────────────┘       │                   │       │                   │
                            │  out_p ───────────┼───────▶ in_p            │
┌─────────────────┐       │  out_n ───────────┼───────▶ in_n            │
│    VddSource      │       │                   │       │                   │
│                   │       │                   │       │  → 统计分析        │
│  vdd ─────────────┼───────▶ vdd              │       │  → CSV保存         │
└─────────────────┘       └─────────────────┘       └─────────────────┘
```

### 4.5 辅助模块说明

#### DiffSignalSource - 差分信号源

支持四种波形类型：
- **DC**：直流信号
- **SINE**：正弦波
- **SQUARE**：方波
- **PRBS**：伪随机序列（PRBS-7）

可配置参数：幅度、频率、共模电压、采样率

#### VddSource - 电源模块

支持三种模式：
- **CONSTANT**：稳定电源
- **SINUSOIDAL**：带正弦纹波的电源（用于PSRR测试）
- **RANDOM**：带随机噪声的电源

#### SignalMonitor - 信号监控器

功能：
- 实时记录波形数据
- 计算统计信息（均值、RMS、峰峰值、最大/最小值）
- 输出CSV格式波形文件

---

## 5. 仿真结果分析

### 5.1 统计指标说明

| 指标 | 计算方法 | 意义 |
|------|----------|------|
| 均值 (mean) | 所有采样点的算术平均 | 反映信号的直流分量 |
| RMS | 均方根 | 反映信号的有效值/功率 |
| 峰峰值 (peak_to_peak) | 最大值 - 最小值 | 反映信号的动态范围 |
| 最大/最小值 | 极值统计 | 用于判断饱和等 |

### 5.2 典型测试结果解读

#### BASIC_PRBS测试结果示例

配置：输入100mV，DC增益2.0，零点1GHz，极点10GHz/20GHz

期望结果：
- 差分输出峰峰值 ≈ 400mV（输入200mV峰峰值 × 2.0 ≈ 400mV）
- 差分输出均值 ≈ 0（PRBS信号平均应为零）
- 共模输出均值 ≈ 0.6V（等于vcm_out配置值）

分析方法：DC增益 = 输出峰峰值 / 输入峰峰值

#### PSRR测试结果解读

- VDD纹波: 100mV @ 1MHz
- 若输出差分纹波 < 1mV：VDD噪声被有效抑制
- 若输出差分纹波较大：PSRR配置已生效，可计算实际PSRR值

PSRR计算：`PSRR_dB = 20 * log10(Vdd_ripple / Vout_diff_ripple)`

#### 饱和测试结果解读

- 输入幅度: 500mV
- 若线性: 输出应为500mV × 2.0 = 1000mV
- 实际输出峰峰值 < 1000mV × 某比例：说明进入饱和区

### 5.3 波形数据文件格式

CSV输出格式：
```
time,diff,cm
0.000000e+00,0.000000,0.600000
1.000000e-11,0.001234,0.600000
...
```

采样点数依据仿真时间和时间步长决定（默认10ps步长，对应100GHz采样率）。

---

## 6. 运行指南

### 6.1 环境配置

运行测试前需要配置环境变量：

```bash
source scripts/setup_env.sh
```

### 6.2 构建与运行

```bash
cd build
cmake ..
make vga_tran_tb
cd tb
./vga_tran_tb [scenario]
```

场景参数：
- `prbs` 或 `0` - 基本PRBS测试（默认）
- `freq` 或 `1` - 频率响应测试
- `psrr` 或 `2` - PSRR测试
- `cmrr` 或 `3` - CMRR测试
- `sat` 或 `4` - 饱和测试

### 6.3 结果查看

测试完成后，控制台输出统计结果，波形数据保存到CSV文件。使用Python进行可视化：

```bash
python scripts/plot_ctle_waveform.py  # 可复用CTLE绘图脚本
```

---

## 7. 技术要点

### 7.1 CMFB代数环处理

**问题**：CMFB环路如果直接使用当前周期输出进行测量，会造成代数环（输出依赖于输出）。

**解决方案**：
- CMFB使用**前一周期的输出**（`m_out_p_prev`, `m_out_n_prev`）进行测量
- 这引入了一个时间步的延迟，但避免了代数环
- 对于低频CMFB（带宽通常为10MHz），这个延迟可以忽略不计

### 7.2 多零点/多极点传递函数

支持任意数量的零点和极点，自动处理多项式卷积。零极点总数建议 ≤ 10，过高阶滤波器可能导致数值不稳定。

### 7.3 软饱和

使用`tanh(x/Vsat)*Vsat`实现平滑饱和特性，减少谐波失真，符合实际电路行为。

### 7.4 可选功能独立控制

PSRR、CMFB、CMRR均可独立启用/禁用，未启用时不创建对应的滤波器对象，节省内存和计算。

### 7.5 时间步设置

默认10ps（100GHz采样率）。采样率应远高于最高极点频率，建议 f_sample ≥ 20-50 × f_pole_max。

### 7.6 PSRR测试特殊要求

PSRR测试场景下，仿真时间必须不少于3微秒，以确保完整覆盖至少3个1MHz周期的信号变化。

### 7.7 VDD端口必须连接

即使不使用PSRR功能，`vdd`端口也必须连接（SystemC-AMS要求）。

### 7.8 与CTLE的主要区别

| 项目 | CTLE | VGA |
|------|------|-----|
| 默认DC增益 | 1.5 | 2.0 |
| 默认零点 | 2 GHz | 1 GHz |
| 默认极点 | 30 GHz | 10 GHz, 20 GHz |
| CMFB环路带宽 | 1 MHz | 10 MHz |
| CMFB环路增益 | 1.0 | 10.0 |
| 主要应用 | 信道均衡 | 可变增益/AGC |

---

## 8. 参考信息

### 8.1 相关文件

| 文件 | 路径 | 说明 |
|------|------|------|
| 参数定义 | `/include/common/parameters.h` | RxVgaParams结构体 |
| 头文件 | `/include/ams/rx_vga.h` | RxVgaTdf类声明 |
| 实现文件 | `/src/ams/rx_vga.cpp` | RxVgaTdf类实现 |
| 测试平台 | `/tb/rx/vga/vga_tran_tb.cpp` | 瞬态仿真测试 |
| 测试辅助 | `/tb/rx/vga/vga_helpers.h` | 信号源和监控器 |
| 单元测试 | `/tests/unit/test_vga_basic.cpp` | GoogleTest单元测试 |

### 8.2 依赖项

- SystemC 2.3.4
- SystemC-AMS 2.3.4
- C++11标准
- GoogleTest 1.12.1（单元测试）

### 8.3 配置示例

基本配置：
```json
{
  "vga": {
    "zeros": [1e9],
    "poles": [10e9, 20e9],
    "dc_gain": 2.0,
    "vcm_out": 0.6
  }
}
```

---

**文档版本**：v0.1  
**最后更新**：2025-12-07  
**作者**：Yizhe Liu
